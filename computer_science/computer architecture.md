计算机：软件（应用软件+系统软件）+硬件

计算机系统
抽象：在更高层次上思考，更少的思考低级实体

计算机体系结构
程序员所见到的计算机系统的属性，概念性的结构与功能特性（指令系统、数据类型、寻址技术、I/O机理）
e.g.有无乘法指令，数据长度是多长

计算机组成
实现计算机体系结构所体现的属性（具体指令的实现）
e.g.如何实现乘法指令（逻辑实现）

---
## Chapter 1 计算机基本结构
计算机执行一条指令的步骤：

- 取指 Fetch
- 译码 Decode
- 执行 Execute
- 回写 Write-back


---
## Chapter 2 指令系统体系结构
一个简单地计算机指令系统
```
运算类指令
     ADD R,M
传送类指令
     LOAD R,M
     STORE M,R
转移类指令
     JMP L
控制类指令
```
>8086通用寄存器：
>   * 数据寄存器x4
>   * 标志寄存器
>   * 指令指针寄存器
>   * 段寄存器x4（物理地址 = 段基址x16+偏移量）

<br>

> x86指令简介     CISC
>* 传送类指令：把数据或地址传送到寄存器或存储器单元中
>   *  MOV DST,SRC
>* 运算类指令
>     * 算术运算指令：完成算术运算，提供运算结果调整、符号扩展等功能
>        *  ADD DST,SRC
>        * INC OPR
>        *  ADC DST,SRC     (带进位的加法)
>     * 逻辑运算和位移指令：实现对二进制位的操作和控制，又称“位操作指令”
>* 转移类指令：改变指令的执行顺序
>* 控制类指令：控制CPU功能，对标志位进行操作

---
>MIPS体系结构     RISC
>* 固定的指令长度（32-bit）（32个通用寄存器（32-bit））
>* 简单的寻址模式
>* 指令数量少、功能简单
>* 只有Load和Store可以访问存储器
>* 需要优秀的编译器支持

MIPS指令简介
基本格式：分三类 R型 I型 J型
R：register 寄存器          6个域
I：immediate 立即数      4个域
J：jump 无条件转移       6个域

---
## Chapter 3 算数逻辑单元
### 算术运算指令
R型
```MIPS
add rd,rs,rt
addu rd,rs,rt     #汇报溢出的加法
sub rd,rs,rt
subu rd,rs,rt     #汇报溢出的减法
```
I型
```MIPS
addi rt,rs,imm     #对立即数进行 符号扩展(扩展用最高位补齐) SignExtImm={16{imm[15]},imm}
addiu rt,rs,imm     #汇报溢出的addi
```

### 逻辑运算指令
R型
```MIPS
and rd,rs,rt
or rd,rs,rt
nor rd,rs,rt
```
I型
```MIPS
andi rt,rs,imm     #对立即数进行 零扩展(扩展位用0补齐) ZeroExtImm={16{1’b0},imm}
ori rt,rs,imm
```

>门电路     由CMOS实现
>寄存器     由D触发器(DFF)实现
>ALU：
>逻辑运算     多路选择器(MUX)
>加法和减法运算     半加器(Half Adder)构成全加器(Full Adder)

有 溢出 不一定有 进位
有 进位 不一定有 溢出
溢出的判断：最高位的进位输入 不等于 最高位的进位输出

加法器的优化
全加器，行波进位加法器(RCA)
改进为：超前进位加法器(CLA)

---
## Chapter 4 乘法器和除法器
优化：性能优化 (减少时钟周期)+ 面积优化(减少寄存器数量)

---
## Chapter 5 单周期处理器
指令系统的需求：

- 算术逻辑单元(ALU)
- 立即数扩展部件
- 程序计数器
- 寄存器堆
- 存储器

处理器控制信号——详见书本（难度太高）

---
## Chapter 6 流水线处理器
流水线不会缩短单条指令的执行时间，而是提高指令的 **吞吐率**

>超级流水线：     #加深流水线
>- 将五级流水线细分为更多的阶段，增加流水线的深度
>- 提升时钟频率，从而提高指令吞吐率
>- 好处：提升了时钟频率；坏处：延迟所占比例增加

<br>

>超标量流水线：     #拓宽流水线
>- 通常，具有两条或两条以上并行工作的流水线结构 称为 超标量结构
>- 使用超标量结构的处理器称为 超标量处理器

**冒险**：阻止下一条指令在下一个时钟周期开始执行的情况
1. 结构冒险：所需的硬件部件正在为之前的指令工作
   * 如果指令和数据放在同一个存储器中，则不能同时读存储器
      * 解决方案1：流水线停顿(stall)，产生空泡(bubble)
      * 解决方案2：指令和数据放在不同的存储器中
   * 如果读寄存器和写寄存器同时发生，如何处理
      * 解决方案：前半个时钟周期写，后半个时钟周期读，并且设置独立的读写口

2.  数据冒险：需要等待之前的指令完成数据的读写
  * 一条指令需要使用之前指令的运算结果，但是结果还没有写回
     *  解决方案1：流水线停顿(stall)，产生空泡(bubble)
     *  解决方案2：数据前递(Forwarding)/也叫 旁路(Bypass)
3. 控制冒险：需要根据之前指令的结果决定下一步的行为
  * 尚未确定是否发生分支，如何进行下一次取值
     * 解决方案1：流水线停顿(stall)，产生空泡(bubble)
     * 解决方案2：延迟转移技术

---
## Chapter 7 存储层次结构
DRAM、SRAM、DDR 工作原理与各项数据 *完全是底层细节，具体看书*

程序的局部性原理：计算机程序从时间和空间都表现出“局部性”
- 时间局部性(Temporal Locality)：最近被访问的存储器单元(指令或数据)很快还会被访问
- 空间局部性(Spatial Locality)：正在被访问的存储器单元附近的单元很快会被访问

*Cache的基本原理：利用时间局部性和空间局部性*

**Cache失效原因：**
- 义务失效(Compulsory Miss):第一次访问某一数据块；也称为冷启失效(Cold Start Miss)
- 容量失效(Capacity Miss):Cache无法保存程序访问所需的所有数据块
- 冲突失效(Conflict Miss):多个存储器位置映射到同一Cache位置

Cache的映射策略：
* 直接映射
* 二路组相联
* 多路组相联
* 全相联

**常见的Cache替换算法：**
- 随机(Random):硬件随机选择一个Cache块替换
- 轮转(Round-Robin):按照预先设定的顺序依次选择Cache块替换
- 最近最少使用(LRU):硬件记录访问历史信息；选择距离现在最长时间未被访问的Cache块替换

---
## Chapter 8 中断和异常 （重点）
**中断向量(interrupt vector)**

- 中断向量：中断服务程序的入口地址
- 每个中断类型对应一个中断向量

逻辑地址生成物理地址——段加偏移：物理地址 = 段基址*16 + 偏移量

>中断处理过程：
>- 关中断：CPU关闭中断响应，即不再接受其它外部中断请求
>- 保存断点：将发生中断处的指令地址压入栈，以使中断处理完后能正确地返回
>- 识别中断源：CPU识别中断的来源，确定中断类型，从而找到相应的中断服务程序的入口地址
>- 保存现场：将发生中断处的有关寄存器(中断服务程序中要使用的寄存器)以及标志寄存器的内容压入栈
>- 执行中断服务程序：转到中断服务程序入口开始执行，可适当时刻重新开放中断，以便允许响应较高优先级的外部中断
>- 恢复现场并返回：把“保存现场”时压入栈的信息弹回原寄存器，然后执行中断返回指令，从而返回主程序继续运行


---
## Chapter 9 输入输出设备
**I/O端口**
- I/O接口内部包含一组称为 I/O端口 的 寄存器
- 每个I/O端口都需要有自己的 端口地址 （或称端口号），以便CPU访问

常见的I/O端口编址方式
1.I/O端口和存储器分开编址：
- I/O映像的I/O方式， I/O Mapped I/O
- x86体系结构采用该方式

2.I/O端口和存储器统一编制：
- 存储器映像的I/O方式，Memory Mapped I/O
- ARM、MIPS、PowerPC等体系结构采用该方式

<br>
*I/O控制方式的分类*
1.程序控制方式：包括如下两种
(1).无条件传送方式：

- 假定外设已经准备好
- CPU直接使用指令与外设传送数据
- 不查询外设的工作状态

(2).程序查询传送方式：

- CPU通过执行一段程序，不断查询外设的工作状态
- 在确定外设已经准备就绪时，才进行数据传送

2.中断控制方式

- CPU和外设并行服务
- 但外设和存储器之间的数据交换仍由CPU承担
- 中断嵌套：CPU响应优先级更高的中断请求

3.直接存储器访问方式，Direct Memory Access (DMA)：

- 数据传送过程不需要CPU干预（不需要执行程序指令）
- 由专门硬件控制电路控制，进行外设与存储器间直接数据传送
- 该专门硬件控制电路称为 DMA控制器，简称DMAC
